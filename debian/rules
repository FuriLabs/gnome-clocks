#!/usr/bin/make -f

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/simple-patchsys.mk
include /usr/share/cdbs/1/rules/utils.mk
include /usr/share/gnome-pkg-tools/1/rules/uploaders.mk
-include /usr/share/gnome-pkg-tools/1/rules/gnome-get-source.mk

GNOME_MODULE := jhbuild

DESTDIR = debian/jhbuild
PREFIX = /usr
BINDIR = $(PREFIX)/bin
DATADIR = $(PREFIX)/share/jhbuild
SYSCONFDIR = /etc

# install files manually
install/jhbuild::
	# data dir holding most stuff
	install -d $(DESTDIR)$(DATADIR)
	# Python code
	cp -a jhbuild $(DESTDIR)$(DATADIR)
	# command line wrapper
	# XXX switch from a jhbuild private module to a public (site-package)
	# module?
	install -d $(DESTDIR)$(BINDIR)
	sed "s,@jhbuilddir@,$(DATADIR),g" < jhbuild.in > $(DESTDIR)$(BINDIR)/jhbuild
	# modulesets
	cp -a modulesets $(DESTDIR)$(DATADIR)
	# patches
	cp -a patches $(DESTDIR)$(DATADIR)
	# TODO doc, scripts
	# TODO install-check (arch: any)
	# Desktop file
	install -d $(DESTDIR)$(PREFIX)/share/applications
	cp -a jhbuild.desktop $(DESTDIR)$(PREFIX)/share/applications
	# bash completion
	install -d $(DESTDIR)$(SYSCONFDIR)/bash_completion.d
	cp -a contrib/jhbuild_completion.bash $(DESTDIR)$(SYSCONFDIR)/bash_completion.d/jhbuild
	# make files with a shebang executable
	egrep -rlZ '^#!(.*)(python|bash)' $(DESTDIR)$(DATADIR) $(DESTDIR)$(SYSCONFDIR) | xargs -0 chmod a+x --
	# cleanup .cvsignore files
	find $(DESTDIR)$(DATADIR) -name .cvsignore -exec rm -f {} \;

binary-install/jhbuild::
	# (should find /usr/share/<package> automatically)
	dh_pycentral -p$(cdbs_curpkg)
